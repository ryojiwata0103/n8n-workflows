name: ğŸ“ Simple Auto PR Creation

# ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿãªè‡ªå‹•PRä½œæˆ
# pushãƒ™ãƒ¼ã‚¹ã®åŸºæœ¬å®Ÿè£…ï¼ˆæœ€ã‚‚å®‰å®šãƒ»ã‚¨ãƒ©ãƒ¼ãŒå°‘ãªã„ï¼‰

on:
  push:
    branches:
      # å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³
      - 'feature/**'
      - 'fix/**' 
      - 'chore/**'
      - 'docs/**'
    # mainãƒ–ãƒ©ãƒ³ãƒã¯é™¤å¤–ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    paths-ignore:
      - 'README.md'
      - '.github/**'

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  auto-create-pr:
    # åŸºæœ¬æ¡ä»¶ãƒã‚§ãƒƒã‚¯: mainãƒ–ãƒ©ãƒ³ãƒã§ã®å®Ÿè¡Œã‚’å®Œå…¨ã«é˜²ã
    if: |
      github.ref != 'refs/heads/main' && 
      github.ref != 'refs/heads/master' && 
      !startsWith(github.ref, 'refs/heads/template')
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # === STEP 1: åŸºæœ¬æƒ…å ±ã®å–å¾— ===
      - name: ğŸ” Get branch info
        id: branch_info
        run: |
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch_name=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          echo "ğŸ“ Current branch: $CURRENT_BRANCH"

      # === STEP 2: é‡è¤‡PRç¢ºèªï¼ˆæœ€ã‚‚é‡è¦ï¼‰ ===
      - name: ğŸ” Check existing PR
        id: check_pr
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          
          # æ—¢å­˜PRç¢ºèª
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number // empty')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "should_create=false" >> $GITHUB_OUTPUT
            echo "âœ… æ—¢å­˜PR #$EXISTING_PR ãŒå­˜åœ¨ - ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          else
            echo "should_create=true" >> $GITHUB_OUTPUT
            echo "ğŸ†• æ–°è¦PRä½œæˆãŒå¿…è¦ã§ã™"
          fi

      # === STEP 3: å¤‰æ›´å†…å®¹åˆ†æ ===
      - name: ğŸ“Š Analyze changes
        id: changes
        if: steps.check_pr.outputs.should_create == 'true'
        run: |
          # main ã¨ã®å·®åˆ†ã‚’ç¢ºèª
          CHANGED_FILES=$(git diff --name-only origin/main..HEAD || echo "")
          FILE_COUNT=$(echo "$CHANGED_FILES" | grep -c . || echo "0")
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT  
          echo "EOF" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ Changed files: $FILE_COUNT"

      # === STEP 4: PRã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ç”Ÿæˆ ===
      - name: ğŸ“ Generate PR content
        id: pr_content
        if: steps.check_pr.outputs.should_create == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          FILE_COUNT="${{ steps.changes.outputs.file_count }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—ã«åŸºã¥ããƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
          if [[ $BRANCH_NAME == feature/* ]]; then
            PR_PREFIX="feat"
          elif [[ $BRANCH_NAME == fix/* ]]; then
            PR_PREFIX="fix"
          elif [[ $BRANCH_NAME == chore/* ]]; then
            PR_PREFIX="chore"
          elif [[ $BRANCH_NAME == docs/* ]]; then
            PR_PREFIX="docs"
          else
            PR_PREFIX="update"
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
          CLEAN_NAME=$(echo "$BRANCH_NAME" | sed 's|^[^/]*/||' | sed 's|-| |g' | sed 's|_| |g')
          PR_TITLE="$PR_PREFIX: $CLEAN_NAME"
          
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_prefix=$PR_PREFIX" >> $GITHUB_OUTPUT
          echo "ğŸ“ PR Title: $PR_TITLE"

      # === STEP 5: PRä½œæˆï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ï¼‰ ===
      - name: ğŸš€ Create Pull Request
        if: steps.check_pr.outputs.should_create == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
          PR_TITLE="${{ steps.pr_content.outputs.pr_title }}"
          FILE_COUNT="${{ steps.changes.outputs.file_count }}"
          
          # ã‚·ãƒ³ãƒ—ãƒ«ãªPRèª¬æ˜æ–‡
          cat > pr_body.md << EOF
## ğŸ“‹ Summary
Auto-generated PR from branch: \`$BRANCH_NAME\`

## ğŸ”§ Changes
- **Files modified**: $FILE_COUNT files
- **Branch type**: ${{ steps.pr_content.outputs.pr_prefix }}

## ğŸ“ Changed Files
$(echo "${{ steps.changes.outputs.changed_files }}" | head -10 | sed 's/^/- `/' | sed 's/$/`/')

## âœ… Checklist
- [ ] Code review
- [ ] Tests passing  
- [ ] Ready to merge

---
ğŸ¤– **Auto-created on**: $(date)
EOF
          
          # PRä½œæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»ç¢ºå®Ÿï¼‰
          gh pr create \
            --title "$PR_TITLE" \
            --body-file pr_body.md \
            --base main \
            --head "$BRANCH_NAME" \
            --label "auto-generated"
          
          echo "âœ… PR created successfully"

      # === STEP 6: çµæœå‡ºåŠ› ===
      - name: ğŸ‰ Success message
        if: steps.check_pr.outputs.should_create == 'true'
        run: |
          echo "ğŸ‰ Auto PR creation completed!"
          echo "Branch: ${{ steps.branch_info.outputs.branch_name }}"
          echo "Files: ${{ steps.changes.outputs.file_count }}"
          echo "Ready for review!"

      - name: âœ… Skip message  
        if: steps.check_pr.outputs.should_create == 'false'
        run: |
          echo "âœ… PR already exists - no action needed"
          echo "Existing PR: #${{ steps.check_pr.outputs.existing_pr }}"